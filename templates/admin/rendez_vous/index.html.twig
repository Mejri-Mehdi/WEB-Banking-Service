{% extends 'admin/base_admin.html.twig' %}

{% block title %}Gestion des Rendez-vous - Admin{% endblock %}

{% block body %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold">Supervision des Rendez-vous</h2>
        <p class="text-muted mb-0">Vue globale de tous les rendez-vous bancaires</p>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form id="search-form" class="row g-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" name="search" id="search-input" class="form-control border-start-0" placeholder="Banque, Client, Référence...">
                </div>
            </div>
            <div class="col-md-3">
                <select name="statut" id="status-filter" class="form-select">
                    <option value="">Tous les statuts</option>
                    <option value="pending">En attente</option>
                    <option value="confirmed">Confirmé</option>
                    <option value="completed">Traité/Fini</option>
                    <option value="cancelled">Annulé</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="date" name="date" id="date-filter" class="form-control">
            </div>
            <div class="col-md-2">
                <button type="button" id="reset-btn" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-x-lg"></i> Reset
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0" id="rdv-table-container">
        {% include 'admin/rendez_vous/_table.html.twig' %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search Logic
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const dateFilter = document.getElementById('date-filter');
        const resetBtn = document.getElementById('reset-btn');
        const container = document.getElementById('rdv-table-container');
        let timeout = null;

        function performSearch() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const searchValue = searchInput.value;
                const statusValue = statusFilter.value;
                const dateValue = dateFilter.value;
                
                const url = new URL(window.location.href);
                if (searchValue) url.searchParams.set('search', searchValue); else url.searchParams.delete('search');
                if (statusValue) url.searchParams.set('statut', statusValue); else url.searchParams.delete('statut');
                if (dateValue) url.searchParams.set('date', dateValue); else url.searchParams.delete('date');

                // Update history without reloading
                window.history.pushState({}, '', url);

                fetch(url, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.text())
                .then(html => {
                    container.innerHTML = html;
                })
                .catch(error => console.error('Error:', error));
            }, 300);
        }

        searchInput.addEventListener('input', performSearch);
        statusFilter.addEventListener('change', performSearch);
        dateFilter.addEventListener('change', performSearch);

        resetBtn.addEventListener('click', () => {
            searchInput.value = '';
            statusFilter.value = '';
            dateFilter.value = '';
            performSearch();
        });
    });
</script>
{% endblock %}
