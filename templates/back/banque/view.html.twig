{% extends 'back/base_agent.html.twig' %}

{% block body %}
<style>
    /* Pagination "style admin" (ronds) */
    .bb-pagination {
        display: flex;
        justify-content: flex-end;
        margin-top: 18px;
    }
    .bb-pagination .pagination {
        gap: 10px;
        margin-bottom: 0;
    }
    .bb-pagination .page-item .page-link {
        width: 46px;
        height: 46px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e9ecef;
        background: #fff;
        color: #111;
        font-weight: 700;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        text-decoration: none;
    }
    .bb-pagination .page-item.active .page-link {
        background: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
        box-shadow: none;
    }
    .bb-pagination .page-item.disabled .page-link {
        opacity: .45;
        pointer-events: none;
        background: #f8f9fa;
    }
    .bb-pagination .page-link:focus { box-shadow: none; }

    /* Recherche + tri */
    .ag-tools {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: flex-end;
        flex-wrap: wrap;
        margin-bottom: 14px;
    }
    .ag-tools .form-control,
    .ag-tools .form-select {
        height: 42px;
        border-radius: 12px;
    }
    .ag-tools .btn {
        height: 42px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 0 14px;
    }
</style>

<div class="mb-4 d-flex align-items-center gap-3">
    {% if banque.logo %}
        <img src="{{ asset(banque.logo) }}"
             alt="Logo {{ banque.nomBq }}"
             style="width:64px;height:64px;object-fit:contain;border-radius:14px;background:#fff;border:1px solid #e9ecef;">
    {% else %}
        <div class="d-flex align-items-center justify-content-center"
             style="width:64px;height:64px;border-radius:14px;background:#fff;border:1px solid #e9ecef;color:#adb5bd;font-weight:700;">
            —
        </div>
    {% endif %}

    <div>
        <h2 style="color: var(--dark-gray); font-weight: 700; margin:0;">{{ banque.nomBq }}</h2>
        <p style="color: var(--medium-gray); margin:6px 0 0;">Informations et agences</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h5 style="color: var(--dark-gray); margin-bottom: 1.5rem;">Informations générales</h5>

                <div class="mb-3">
                    <label style="color: var(--medium-gray); font-size: 0.875rem; font-weight: 600;">Site web</label>
                    <p class="mb-0">
                        {% if banque.siteWeb %}
                            <a href="{{ banque.siteWeb }}" target="_blank" rel="noopener">{{ banque.siteWeb }}</a>
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </p>
                </div>

                <div class="mb-3">
                    <label style="color: var(--medium-gray); font-size: 0.875rem; font-weight: 600;">Email</label>
                    <p class="mb-0">{{ banque.emailBq ?: '—' }}</p>
                </div>

                <div class="mb-3">
                    <label style="color: var(--medium-gray); font-size: 0.875rem; font-weight: 600;">Téléphone</label>
                    <p class="mb-0">{{ banque.telephoneBq ?: '—' }}</p>
                </div>

                {% if banque.description %}
                    <div class="mb-3">
                        <label style="color: var(--medium-gray); font-size: 0.875rem; font-weight: 600;">Description</label>
                        <p class="mb-0">{{ banque.description }}</p>
                    </div>
                {% endif %}

                <a href="{{ path('agent_banque_edit') }}" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Modifier les informations
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body d-flex flex-column">

                {# OUTILS: Recherche + tri (rectangle rouge sur ta capture) #}
                <form method="get" action="{{ path('agent_banque_view') }}" class="ag-tools">
                    <input
                        type="text"
                        name="q"
                        class="form-control"
                        style="min-width: 260px;"
                        placeholder="Rechercher une agence (nom, adresse)…"
                        value="{{ q|default('')|e }}"
                    >

                    {% set currentSort = sort|default('id') %}
                    {% set currentDir = dir|default('desc') %}
                    {% set currentValue = currentSort ~ '_' ~ currentDir %}

                    <select name="s" class="form-select" style="min-width: 230px;">
                        <option value="nom_asc"  {{ currentValue == 'nom_asc'  ? 'selected' : '' }}>Nom (A → Z)</option>
                        <option value="nom_desc" {{ currentValue == 'nom_desc' ? 'selected' : '' }}>Nom (Z → A)</option>
                        <option value="id_asc"   {{ currentValue == 'id_asc'   ? 'selected' : '' }}>ID (croissant)</option>
                        <option value="id_desc"  {{ currentValue == 'id_desc'  ? 'selected' : '' }}>ID (décroissant)</option>
                    </select>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Rechercher
                    </button>

                    <a class="btn btn-outline-secondary"
                       href="{{ path('agent_banque_view') }}"
                       title="Réinitialiser">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </a>

                    {# ap reset implicit: on ne met pas ap dans le form #}
                </form>

                {# On transforme s=nom_asc etc en sort/dir côté controller via query params classiques #}
                {# Astuce: on ne peut pas "parser" facilement en Twig dans controller, donc on envoie sort/dir via JS minimal #}
                {# MAIS on peut faire plus simple: on encode sort/dir en champs cachés et on les remplit en JS #}

                <script>
                    (function(){
                        const form = document.currentScript.previousElementSibling;
                        if(!form) return;

                        // Inject hidden inputs sort/dir, and keep select name as "s"
                        let sort = form.querySelector('input[name="sort"]');
                        let dir  = form.querySelector('input[name="dir"]');

                        if(!sort){
                            sort = document.createElement('input');
                            sort.type = 'hidden';
                            sort.name = 'sort';
                            form.appendChild(sort);
                        }
                        if(!dir){
                            dir = document.createElement('input');
                            dir.type = 'hidden';
                            dir.name = 'dir';
                            form.appendChild(dir);
                        }

                        const sel = form.querySelector('select[name="s"]');
                        function apply(){
                            const val = (sel && sel.value) ? sel.value : 'id_desc';
                            const parts = val.split('_');
                            sort.value = parts[0] || 'id';
                            dir.value  = parts[1] || 'desc';
                        }
                        if(sel){
                            sel.addEventListener('change', apply);
                            apply();
                        }
                    })();
                </script>

                <div class="d-flex justify-content-between align-items-center mb-3 mt-2">
                    <h5 style="color: var(--dark-gray); margin:0;">
                        Agences ({{ agences.getTotalItemCount }})
                    </h5>
                    <a href="{{ path('agent_agence_new') }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle"></i> Nouvelle agence
                    </a>
                </div>

                {% if agences.getTotalItemCount > 0 %}
                    <div class="list-group list-group-flush">
                        {% for agence in agences %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 style="color: var(--dark-gray);">{{ agence.nomAg }}</h6>
                                        <p style="color: var(--medium-gray); font-size: 0.875rem; margin-bottom: 0;">
                                            {{ agence.adresseAg ?: '—' }}
                                        </p>
                                    </div>

                                    <div class="d-flex align-items-center gap-1">
                                        <a href="{{ path('agent_agence_view', {id: agence.id}) }}"
                                           class="btn btn-sm btn-outline-secondary"
                                           title="Voir">
                                            <i class="bi bi-eye"></i>
                                        </a>

                                        <a href="{{ path('agent_agence_edit', {id: agence.id}) }}"
                                           class="btn btn-sm btn-outline-primary"
                                           title="Modifier">
                                            <i class="bi bi-pencil"></i>
                                        </a>

                                        <form method="post"
                                              action="{{ path('agent_agence_delete', {id: agence.id}) }}"
                                              class="d-inline">
                                            <input type="hidden" name="_token" value="{{ csrf_token('agent_agence_delete_' ~ agence.id) }}">
                                            <button type="submit"
                                                    class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Êtes-vous sûr ?')"
                                                    title="Supprimer">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    {# Pagination en bas à droite - style admin + conserve q/sort/dir #}
                    {% set p = agences.paginationData %}
                    {% if p.pageCount > 1 %}
                        <div class="mt-auto pt-3">
                            <nav class="bb-pagination" aria-label="Pagination agences">
                                <ul class="pagination">
                                    {% set baseParams = app.request.query.all %}
                                    {# on enlève "s" si présent (on ne l'utilise pas côté controller) #}
                                    {% if baseParams.s is defined %}
                                        {% set baseParams = baseParams|merge({'s': null}) %}
                                    {% endif %}

                                    {# Previous #}
                                    {% if p.previous is defined %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="{{ path('agent_banque_view', baseParams|merge({'ap': p.previous})) }}"
                                               aria-label="Précédent">
                                                <i class="bi bi-chevron-left"></i>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link" aria-label="Précédent">
                                                <i class="bi bi-chevron-left"></i>
                                            </span>
                                        </li>
                                    {% endif %}

                                    {# Pages #}
                                    {% for page in p.pagesInRange %}
                                        {% if page == p.current %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ page }}</span>
                                            </li>
                                        {% else %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                   href="{{ path('agent_banque_view', baseParams|merge({'ap': page})) }}">
                                                    {{ page }}
                                                </a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}

                                    {# Next #}
                                    {% if p.next is defined %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="{{ path('agent_banque_view', baseParams|merge({'ap': p.next})) }}"
                                               aria-label="Suivant">
                                                <i class="bi bi-chevron-right"></i>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link" aria-label="Suivant">
                                                <i class="bi bi-chevron-right"></i>
                                            </span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-building" style="font-size: 3rem; color: var(--medium-gray);"></i>
                        <p style="color: var(--medium-gray); margin-top: 1rem;">Aucune agence</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}